/*
 * bsp_ntc.c
 *
 *  Created on: Aug 14, 2025
 *      Author: Admin
 */

#include "board.h"
#include "bsp_ntc.h"
#include "math.h"
#include "stm32f4xx_ll_adc.h"


/**
 * @brief  Chuyển giá trị ADC thành nhiệt độ (độ C, số nguyên)
 * @param  adc_value: Giá trị ADC (0-65535, kiểu uint16_t)
 * @retval Nhiệt độ (độ C, số nguyên có dấu)
 *
 */
int32_t bsp_ntc_ADC_to_Temperature(uint16_t adc_value) {
    // Hằng số cho NTC
    const float R0 = 10000.0f;    // Điện trở NTC tại 25°C (10K)
    const float T0 = 298.15f;     // Nhiệt độ tham chiếu (25°C = 298.15K)
    const float BETA = 4050.0f;   // Hằng số Beta của NTC
    const float R_REF = 10000.0f; // Điện trở nối xuống đất (10K)


    // Tính điện trở NTC từ giá trị ADC
    float R_NTC = R_REF * ((65535.0f / adc_value) - 1.0f); // Công thức: R_NTC = R_REF * (65535/ADC - 1)

    // Tính nhiệt độ bằng công thức Beta
    float inv_T = (1.0f / T0) + (1.0f / BETA) * logf(R_NTC / R0);
    float T_kelvin = 1.0f / inv_T;
    float T_celsius = T_kelvin - 273.15f;

    // Làm tròn về số nguyên
    int32_t temperature = (int32_t)(T_celsius + 0.5f); // Làm tròn lên nếu >= 0.5

    return temperature;
}

int32_t bsp_ntc_temperature_conv(void)
{

    if (!LL_ADC_IsEnabled(NTC_ADC))
    {
        LL_ADC_Enable(NTC_ADC);
    }
    LL_ADC_REG_StartConversionSWStart(NTC_ADC);

    while(!LL_ADC_IsActiveFlag_EOCS(NTC_ADC));
    uint16_t raw = LL_ADC_REG_ReadConversionData12(NTC_ADC);
    return bsp_ntc_ADC_to_Temperature(raw);
}
